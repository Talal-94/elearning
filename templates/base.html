{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}eLearning{% endblock %}</title>
    {% comment %} Bootstrap 5  {% endcomment %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="{% url 'home' %}">eLearning</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample"
          aria-controls="navbarsExample" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div id="navbarsExample" class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Dashboard</a></li>
            {% if user.is_authenticated and user.role == 'teacher' %}
              <li class="nav-item"><a class="nav-link" href="{% url 'course_create' %}">New Course</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'user_search' %}">Find/Block Users</a></li>
            {% endif %}
          </ul>
          <ul class="navbar-nav ms-auto">
            {% if user.is_authenticated %}
              <li class="nav-item">
                <a class="nav-link" href="{% url 'user_profile' user.username %}">
                  Hello, <strong>{{ user.username }}</strong>
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link position-relative" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  ðŸ””
                  <span id="notif-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notifDropdown" style="min-width: 260px;">
                  <li class="dropdown-header">Notifications</li>
                  <li>
                    <ul id="notif-list" class="list-unstyled mb-0 px-2" style="max-height:260px; overflow:auto;"></ul>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{% url 'notifications_list' %}">View all</a></li>
                </ul>
              </li>
              <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
            {% else %}
              <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'signup' %}">Sign up</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    {% if messages %}
      <div class="container mt-3">
        {% for message in messages %}
          <div class="alert 
            {% if 'success' in message.tags %}alert-success
            {% elif 'warning' in message.tags %}alert-warning
            {% elif 'error' in message.tags %}alert-danger
            {% else %}alert-info{% endif %}
            alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <main class="container py-4">
      {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}
<script>
(function () {
  const badge = document.getElementById('notif-badge');
  const listEl = document.getElementById('notif-list');
  if (!badge || !listEl) return;

  function setBadge(n) {
    badge.textContent = n;
    badge.classList.toggle('d-none', !n || n <= 0);
  }

  function liFor(item) {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.className = 'dropdown-item py-2';
    a.href = item.url || '#';
    a.textContent = item.verb || '(notification)';
    li.appendChild(a);
    return li;
  }

  function renderList(items) {
    listEl.innerHTML = '';
    if (!items || !items.length) {
      const li = document.createElement('li');
      li.className = 'px-3 py-2 text-muted';
      li.textContent = 'No notifications';
      listEl.appendChild(li);
      return;
    }
    items.forEach(it => listEl.appendChild(liFor(it)));
  }

  async function fetchCount() {
    try {
      const r = await fetch("{% url 'notifications_unread_count' %}", {headers: {"X-Requested-With":"XMLHttpRequest"}});
      const d = await r.json();
      setBadge(d.count || 0);
    } catch (_) {}
  }

  async function fetchRecent() {
    try {
      // Add this tiny JSON endpoint below (accounts.views.notifications_recent_json)
      const r = await fetch("{% url 'notifications_recent_json' %}?limit=10", {headers: {"X-Requested-With":"XMLHttpRequest"}});
      const d = await r.json();
      renderList(d.results || []);
    } catch (_) {}
  }

  document.getElementById('notifDropdown')
    .addEventListener('shown.bs.dropdown', () => { fetchRecent(); });

  fetchCount();
  setInterval(fetchCount, 30000);

  const scheme = (location.protocol === "https:") ? "wss" : "ws";
  const wsUrl = `${scheme}://${window.location.host}/ws/notifications/`;
  try {
    const socket = new WebSocket(wsUrl);
    socket.onmessage = (e) => {
      const data = JSON.parse(e.data); 
      if (listEl.children.length && !listEl.firstElementChild.classList.contains('text-muted')) {
        listEl.prepend(liFor(data));
      } else {
        renderList([data]); 
      }

      const inc = (data.unread_increment ? 1 : 0);
      const current = parseInt(badge.textContent || "0", 10) || 0;
      setBadge(current + inc);
    };
  } catch (_) {}
})();
</script>


  </body>
</html>
