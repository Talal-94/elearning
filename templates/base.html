{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}eLearning{% endblock %}</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="{% url 'home' %}">eLearning</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample"
          aria-controls="navbarsExample" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div id="navbarsExample" class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="{% url 'course_list' %}">Courses</a></li>
            {% if user.is_authenticated and user.role == 'teacher' %}
              <li class="nav-item"><a class="nav-link" href="{% url 'course_create' %}">New Course</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'user_search' %}">Find/Block Users</a></li>
            {% endif %}
          </ul>
          <ul class="navbar-nav ms-auto">
            {% if user.is_authenticated %}
              <li class="nav-item">
                <a class="nav-link" href="{% url 'user_profile' user.username %}">
                  Hello, <strong>{{ user.username }}</strong>
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link position-relative" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  ðŸ””
                  <span id="notif-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
                </a>
                <ul class=" nav-item dropdown-menu dropdown-menu-end" aria-labelledby="notifDropdown">
                  <li class="dropdown-header">Notifications</li>
                  <li><div id="notif-list" style="max-height:260px; overflow:auto;"></div></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="{% url 'notifications_list' %}">View all</a></li>
                </ul>
              </li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">Dashboard</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
            {% else %}
              <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'signup' %}">Sign up</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    {% if messages %}
      <div class="container mt-3">
        {% for message in messages %}
          <div class="alert 
            {% if 'success' in message.tags %}alert-success
            {% elif 'warning' in message.tags %}alert-warning
            {% elif 'error' in message.tags %}alert-danger
            {% else %}alert-info{% endif %}
            alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <main class="container py-4">
      {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}
    <script>
(function () {
  const badge = document.getElementById('notif-badge');
  const list = document.getElementById('notif-list');
  if (!badge || !list) return;

  function setBadge(n) {
    badge.textContent = n;
    badge.classList.toggle('d-none', n <= 0);
  }
  function prependItem(item) {
    const a = document.createElement('a');
    a.className = 'dropdown-item';
    a.href = item.url || '#';
    a.textContent = item.verb;
    list.prepend(a);
  }

  let count = 0;
  fetch("{% url 'notifications_unread_count' %}", {headers: {"X-Requested-With":"XMLHttpRequest"}})
    .then(r => r.json()).then(d => { count = d.count || 0; setBadge(count); }).catch(() => {});

  const scheme = (window.location.protocol === "https:") ? "wss" : "ws";
  const wsUrl = `${scheme}://${window.location.host}/ws/notifications/`;
  let socket;
  try {
    socket = new WebSocket(wsUrl);
    socket.onmessage = (e) => {
      const data = JSON.parse(e.data);
      prependItem(data);
      count = (count || 0) + (data.unread_increment ? 1 : 0);
      setBadge(count);
    };
  } catch(e) {}

  setInterval(() => {
    fetch("{% url 'notifications_unread_count' %}", {headers: {"X-Requested-With":"XMLHttpRequest"}})
      .then(r => r.json()).then(d => setBadge(d.count || 0)).catch(() => {});
  }, 30000);
})();
</script>
  </body>
</html>
