{% extends "base.html" %}
{% block title %}Chat · eLearning{% endblock %}
{% block content %}
<h1 class="h4 mb-3">
  Chat — <a href="{% url 'course_detail' course.id %}">{{ course.title }}</a>
</h1>

<div class="card shadow-sm">
  <div class="card-body">
    <div id="chat-log" class="border rounded p-2 mb-2" style="height: 260px; overflow:auto;"></div>
    <div class="input-group">
      <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message…" />
      <button id="chat-message-submit" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const roomName = "{{ course.id }}";
  const wsScheme = (location.protocol === "https:") ? "wss" : "ws";
  const chatSocket = new WebSocket(wsScheme + "://" + window.location.host + "/ws/chat/" + roomName + "/");

  chatSocket.onopen = () => console.log("[Chat] open");
  chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const log = document.getElementById("chat-log");
    const p = document.createElement("p");
    p.className = "mb-1";
    p.textContent = data.user + ": " + data.message;
    log.appendChild(p);
    log.scrollTop = log.scrollHeight;
  };
  chatSocket.onerror = (e) => console.log("[Chat] error", e);
  chatSocket.onclose = () => console.log("[Chat] closed");

  document.getElementById("chat-message-submit").onclick = () => {
    const input = document.getElementById("chat-message-input");
    if (input.value.trim().length === 0) return;
    chatSocket.send(JSON.stringify({ "message": input.value }));
    input.value = "";
    input.focus();
  };
</script>
{% endblock %}
