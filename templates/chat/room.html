{% extends "base.html" %}
{% block content %}
  <div class="card shadow-sm">
    <div class="card-header">Chat — {{ course.title }}</div>
    <div class="card-body">
      <div id="chat-log" class="form-control mb-3" style="height:300px; overflow:auto;"></div>
      <div class="input-group">
        <input id="chat-message-input" type="text" class="form-control" placeholder="Type your message…">
        <button id="chat-message-submit" class="btn btn-primary">Send</button>
      </div>
    </div>
  </div>

  <script>
    const roomName = "{{ room_id }}";
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');

    chatSocket.onopen  = () => console.log("[Chat] open");
    chatSocket.onerror = e => console.error("[Chat] error", e);
    chatSocket.onclose = () => console.warn("[Chat] closed");
    chatSocket.onmessage = e => {
      const data = JSON.parse(e.data);
      const log = document.getElementById('chat-log');
      log.innerHTML += `<div><strong>${data.user}:</strong> ${data.message}</div>`;
      log.scrollTop = log.scrollHeight;
    };

    document.getElementById('chat-message-submit').onclick = () => {
      const input = document.getElementById('chat-message-input');
      const msg = input.value.trim();
      if (!msg) return;
      chatSocket.send(JSON.stringify({ message: msg }));
      input.value = '';
    };
  </script>
{% endblock %}
