{% extends "base.html" %}
{% block title %}Chat · eLearning{% endblock %}

{% block content %}
<h1 class="h4 mb-3">
  Chat — <a href="{% url 'course_detail' course.id %}">{{ course.title }}</a>
</h1>

<div class="card shadow-sm">
  <div class="card-body">
    <div id="chat-log" class="border rounded p-2 mb-2" style="height: 260px; overflow:auto;">
      {% for m in history %}
        <div class="msg {% if m.user_id == me_id %}me{% endif %} {% if m.user_id == instructor_id %}instructor{% endif %}">
          <div class="small text-muted d-flex align-items-center gap-2">
            <span class="fw-semibold">
              {% if m.user_id == me_id %}You{% else %}{{ m.user.username }}{% endif %}
            </span>
            {% if m.user_id == instructor_id %}
              <span class="badge bg-warning text-dark">Instructor</span>
            {% endif %}
            <span>· {{ m.created_at|date:"H:i" }}</span>
          </div>
          <div class="bubble">{{ m.content }}</div>
        </div>
      {% empty %}
        <div class="text-muted">No messages yet.</div>
      {% endfor %}
    </div>

    <div class="input-group">
      <input id="chat-message-input" type="text" class="form-control" placeholder="Type a message…" />
      <button id="chat-message-submit" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>

<style>
  /* minimal bubbles & highlighting */
  #chat-log .msg { margin-bottom: .5rem; }
  #chat-log .msg .bubble {
    display: inline-block;
    padding: .4rem .6rem;
    border-radius: .5rem;
    background: #f1f3f5;
  }
  #chat-log .msg.me .bubble { background: #d7efff; }        
  #chat-log .msg.instructor .bubble { background: #fff3cd; }
</style>
{% endblock %}

{% block extra_js %}
<script>
  const ROOM_ID = {{ course.id }};
  const ME_ID = {{ me_id }};
  const INSTRUCTOR_ID = {{ instructor_id }};
  const wsScheme = (location.protocol === "https:") ? "wss" : "ws";
  const wsUrl = wsScheme + "://" + window.location.host + "/ws/chat/" + ROOM_ID + "/";

  const logEl = document.getElementById("chat-log");
  const inputEl = document.getElementById("chat-message-input");
  const sendBtn = document.getElementById("chat-message-submit");

  function appendMessage({ user, message, timestamp }) {
    const uid = user && user.id;
    const uname = user && user.username ? user.username : "unknown";
    const isMe = (uid === ME_ID);
    const isInstructor = (uid === INSTRUCTOR_ID);

    const wrap = document.createElement("div");
    wrap.className = "msg" + (isMe ? " me" : "") + (isInstructor ? " instructor" : "");

    const meta = document.createElement("div");
    meta.className = "small text-muted d-flex align-items-center gap-2";

    const name = document.createElement("span");
    name.className = "fw-semibold";
    name.textContent = isMe ? "You" : uname;
    meta.appendChild(name);

    if (isInstructor) {
      const badge = document.createElement("span");
      badge.className = "badge bg-warning text-dark";
      badge.textContent = "Instructor";
      meta.appendChild(badge);
    }

    const time = document.createElement("span");
    if (timestamp) {
      try {
        const d = new Date(timestamp);
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        time.textContent = "· " + hh + ":" + mm;
        meta.appendChild(time);
      } catch (_) {}
    }

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = message;

    wrap.appendChild(meta);
    wrap.appendChild(bubble);
    logEl.appendChild(wrap);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // WebSocket
  const chatSocket = new WebSocket(wsUrl);
  chatSocket.onopen = () => console.log("[Chat] open");

  chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    appendMessage({
      user: data.user || {},
      message: data.message || "",
      timestamp: data.timestamp || null
    });
  };

  chatSocket.onerror = (e) => console.log("[Chat] error", e);
  chatSocket.onclose = () => console.log("[Chat] closed");

  function sendCurrent() {
    const txt = inputEl.value.trim();
    if (!txt) return;
    chatSocket.send(JSON.stringify({ message: txt }));
    inputEl.value = "";
    inputEl.focus();
  }

  sendBtn.addEventListener("click", sendCurrent);
  inputEl.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") sendCurrent();
  });
</script>
{% endblock %}
