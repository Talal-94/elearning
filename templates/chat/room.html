{% extends "base.html" %} {% block content %}
<h2>Chat – {{ course.title }}</h2>

<!-- Chat log area -->
<div
  id="chat-log"
  style="
    border: 1px solid #ccc;
    height: 300px;
    overflow-y: scroll;
    padding: 10px;
  "
></div>

<!-- Message input -->
<input
  id="chat-message-input"
  type="text"
  size="100"
  placeholder="Type your message…"
  autofocus
/>
<button id="chat-message-submit">Send</button>

<script>
  const roomName = "{{ room_name }}";
  const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
  );

  console.log("[Chat] connecting to", chatSocket.url);
  chatSocket.onopen = () => console.log("[Chat] open");
  chatSocket.onerror = (e) => console.error("[Chat] error", e);
  chatSocket.onclose = () => console.warn("[Chat] closed");
  chatSocket.onmessage = (e) => {
    console.log("[Chat] message raw:", e.data);
    const data = JSON.parse(e.data);
    const log = document.querySelector("#chat-log");
    log.innerHTML += `<p><strong>${data.user}:</strong> ${data.message}</p>`;
    log.scrollTop = log.scrollHeight;
  };

  document.querySelector("#chat-message-submit").onclick = () => {
    const input = document.querySelector("#chat-message-input");
    if (input.value.trim()) {
      chatSocket.send(JSON.stringify({ message: input.value }));
      input.value = "";
    }
  };
</script>
{% endblock %}
